<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>日程投票フォーム</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      :root{
        --bg:#0b0c0f;
        --card:#14161a;
        --muted:#8a8f98;
        --text:#e6e8eb;
        --line:#23262d;
        --accent:#00c300;
        --yes:#1db954;   /* green */
        --maybe:#ffb020; /* amber */
        --no:#ef5350;    /* red */
      }
      @media (prefers-color-scheme: light){
        :root{
          --bg:#f6f7f9; --card:#ffffff; --muted:#5c636f; --text:#16181d; --line:#e6e8eb; --accent:#00b800;
        }
      }
      *{ box-sizing: border-box; }
      body{
        font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans JP',sans-serif;
        margin:0; background:var(--bg); color:var(--text);
      }
      .container{ max-width:880px; margin:0 auto; padding:20px 16px 88px; }
      .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.12); }
      .header{ display:flex; align-items:baseline; gap:12px; margin-bottom:10px; }
      #title{ margin:0; font-size:20px; line-height:1.3; }
      .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.06); color:var(--muted); font-size:12px; border:1px solid var(--line); }
      #user{ color:var(--muted); font-size:12px; }
      .notice{ margin:0 0 12px; padding:14px 16px; border:1px solid var(--line); border-radius:10px; background: rgba(255,193,7,.12); color: var(--text); font-size:14px; }
      .hidden{ display:none; }
      .legend{ display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px; margin:6px 0 2px; }
      .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.04); font-size:12px; color:var(--muted); }
      .list{ margin-top:8px; }
      .option{ display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:center; padding:12px 0; border-bottom:1px solid var(--line); }
      .label{ font-weight:600; letter-spacing:.2px; }
      .choices{ display:flex; gap:8px; }
      /* Radio as segmented chips */
      .choices input[type=radio]{ position:absolute; opacity:0; pointer-events:none; }
      .choice{ display:inline-flex; align-items:center; justify-content:center; min-width:40px; padding:8px 10px; border-radius:8px; border:1px solid var(--line); background:rgba(255,255,255,.02); color:var(--muted); font-weight:600; cursor:pointer; user-select:none; transition:all .15s ease; }
      .choice.yes{ border-color: color-mix(in oklab, var(--yes) 40%, var(--line)); color: var(--yes); }
      .choice.maybe{ border-color: color-mix(in oklab, var(--maybe) 40%, var(--line)); color: var(--maybe); }
      .choice.no{ border-color: color-mix(in oklab, var(--no) 40%, var(--line)); color: var(--no); }
      /* Selected state: invert with theme color background and white glyph */
      .choices input[type=radio]:checked + .choice.yes{ background: var(--yes); border-color: var(--yes); color:#fff; box-shadow:none; }
      .choices input[type=radio]:checked + .choice.maybe{ background: var(--maybe); border-color: var(--maybe); color:#fff; box-shadow:none; }
      .choices input[type=radio]:checked + .choice.no{ background: var(--no); border-color: var(--no); color:#fff; box-shadow:none; }
      .choices input[type=radio]:disabled + .choice{ opacity:.5; cursor:not-allowed; }
      .tally{ font-size:12px; color:var(--muted); text-align:right; white-space:nowrap; }
      /* Save bar */
      .savebar{ position:sticky; bottom:0; left:0; right:0; backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.25)); padding:14px 0 0; margin-top:10px; }
      .save{ width:100%; padding:12px 16px; background:var(--accent); color:#fff; border:none; border-radius:10px; font-weight:800; letter-spacing:.4px; box-shadow: 0 8px 16px rgba(0,195,0,.25); }
      .save.disabled, .save:disabled{ background:#8d949a; box-shadow:none; cursor:not-allowed; }
      .row{ margin-top:8px; font-size:13px; }
      .error{ color:#ff6b6b; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div id="extNotice" class="notice hidden"></div>
        <div class="header">
          <h3 id="title">日程投票</h3>
          <span id="deadline" class="badge">締切: -</span>
        </div>
        <div id="user" class="legend"></div>
        <div class="legend">
          <span class="pill">○ 賛成</span>
          <span class="pill">△ どちらでも</span>
          <span class="pill">× 不可</span>
        </div>
        <div id="list" class="list"></div>
        <div class="savebar">
          <button id="save" class="save">保存</button>
          <div id="msg" class="row"></div>
        </div>
      </div>
    </div>

    <script type="module">
      let LIFF_ID = (window.__LIFF_ID__ || '').trim();
      let LOGIN_CID = '';
      function getPollId(){
        const qs = new URLSearchParams(location.search);
        let pid = qs.get('pollId');
        if (!pid) {
          const st = qs.get('liff.state');
          if (st) {
            try {
              const decoded = decodeURIComponent(st);
              // decoded may be a path like /liff/index.html?pollId=... or include fragments
              const u = new URL(decoded, location.origin);
              pid = new URLSearchParams(u.search).get('pollId') || pid;
            } catch {}
          }
        }
        return pid;
      }
      let pollId = getPollId();
      const $list = document.getElementById('list');
      const $msg = document.getElementById('msg');
      const $save = document.getElementById('save');

      let idToken = null;
      let state = { options: [], tally: [], userChoices: [] };
      let pollClosed = false;

      function choiceName(n){ return n===2?'○':n===1?'△':'×'; }

      function render(){
        $list.innerHTML = '';
        state.options.forEach(opt => {
          const row = document.createElement('div');
          row.className = 'option';
          const label = document.createElement('div');
          label.className = 'label';
          label.textContent = opt.label;
          const choices = document.createElement('div');
          choices.className = 'choices';
          [2,1,0].forEach(val => {
            const id = `${opt.id}_${val}`;
            const r = document.createElement('input');
            r.type = 'radio';
            r.name = opt.id;
            r.value = String(val);
            r.id = id;
            if (pollClosed) r.disabled = true;
            const mine = state.userChoices.find(c => c.option_id === opt.id);
            if (mine && String(mine.choice) === String(val)) r.checked = true;
            const l = document.createElement('label');
            l.htmlFor = id;
            l.textContent = choiceName(val);
            l.className = 'choice ' + (val===2?'yes':val===1?'maybe':'no');
            choices.appendChild(r);
            choices.appendChild(l);
          });
          const tall = state.tally.find(t => t.option_id === opt.id) || { yes_count:0, maybe_count:0, no_count:0 };
          const t = document.createElement('div');
          t.className = 'tally';
          t.textContent = `○${tall.yes_count} / △${tall.maybe_count} / ×${tall.no_count}`;
          row.appendChild(label);
          row.appendChild(choices);
          row.appendChild(t);
          $list.appendChild(row);
        });
      }

      async function init(){
        if (!LIFF_ID) {
          const cfg = await fetch('/api/public-config').then(r=>r.json()).catch(()=>({}));
          LIFF_ID = (cfg.liffId || '').trim();
          LOGIN_CID = (cfg.loginChannelId || '').trim();
        } else {
          try {
            const cfg = await fetch('/api/public-config').then(r=>r.json());
            LOGIN_CID = (cfg.loginChannelId || '').trim();
          } catch {}
        }
        const basicOk = /^[0-9A-Za-z_-]{10,}$/.test(LIFF_ID);
        const looksLikeChannelId = /^\d{8,}$/.test(LIFF_ID); // ただの数字列はチャネルIDの可能性大
        const looksLikeLiffId = /^\d{5,}-[0-9A-Za-z_-]+$/.test(LIFF_ID); // 例: 165xxxx-xxxxx
        if (!basicOk || looksLikeChannelId || !looksLikeLiffId) {
          document.getElementById('msg').innerHTML = 'LIFF_ID が不正です。<br>例: <code>1651234567-abCdEf</code> の形式になっているか確認し、<br>チャネルID（数字のみ）を入れていないか確認してください。';
          return;
        }
        try{
          await liff.init({ liffId: LIFF_ID});
        }catch(e){
          document.getElementById('msg').textContent = 'LIFF 初期化に失敗: ' + (e?.message || e);
          return;
        }
        // If in external browser, do not render the form at all
        if (!liff.isInClient()){
          const $card = document.querySelector('.card');
          if ($card){
            $card.innerHTML = '<div class="notice">スマートフォンのLINEアプリじゃないと利用できません。</div>';
          } else {
            document.body.innerHTML = '<div class="notice">スマートフォンのLINEアプリじゃないと利用できません。</div>';
          }
          return;
        }
        // Ensure login with openid scope when outside client
        const u = new URL(location.href);
        const retried = u.searchParams.get('relogin') === '1';
        if (!liff.isInClient() && !liff.isLoggedIn()) {
          u.searchParams.set('relogin', '1');
          liff.login({ scope: ['openid','profile'], prompt: 'consent', redirectUri: u.toString() });
          return; // will redirect
        }
        // After LIFF second redirect, pollId may now be directly in location.search
        pollId = getPollId();
        idToken = liff.getIDToken();
        // Some environments may not issue ID token unless openid scope was granted
        if (!idToken && !retried) {
          u.searchParams.set('relogin', '1');
          try {
            liff.login({ scope: ['openid','profile'], prompt: 'consent', redirectUri: u.toString() });
            return;
          } catch {}
        }
        const decoded = liff.getDecodedIDToken?.();
        if (!idToken) {
          document.getElementById('msg').innerHTML = '<span class="error">ログイン情報の取得に失敗しました（IDトークン未取得）。LINE Loginのスコープに <code>openid</code> が含まれているか確認してください。</span>';
          return;
        }
        if (decoded && LOGIN_CID && String(decoded.aud) !== String(LOGIN_CID)) {
          document.getElementById('msg').innerHTML = `<span class="error">ログイン設定エラー: IDトークンのaud(${decoded.aud})とサーバ設定のLINE_LOGIN_CHANNEL_ID(${LOGIN_CID})が一致しません。開いているURLのドメインとLIFF設定、ログインチャネルIDをご確認ください。</span>`;
          return;
        }
        await load();
        subscribe();
      }

      // debug表示: ?debug=1 を付けると主要情報を出力
      (function(){
        const dbg = new URLSearchParams(location.search).get('debug');
        if (dbg === '1') {
          const qs = new URLSearchParams(location.search);
          const st = qs.get('liff.state');
          const pre = document.createElement('pre');
          pre.style.fontSize = '12px';
          pre.style.color = '#666';
          pre.textContent = [
            `LIFF_ID=${LIFF_ID}`,
            `href=${location.href}`,
            `liff.state=${st || ''}`,
          ].join('\n');
          document.body.appendChild(pre);
        }
      })();

      async function load(){
        $msg.textContent = '';
        const res = await fetch(`/api/polls/${encodeURIComponent(pollId)}`, {
          headers: { Authorization: `Bearer ${idToken}` }
        });
        if (!res.ok){
          let detail = '';
          try{
            const j = await res.json();
            detail = (j && (j.detail || j.error)) || '';
          }catch{}
          if (res.status === 401){
            const btn = document.createElement('button');
            btn.className = 'save';
            btn.textContent = '再ログイン';
            btn.onclick = () => {
              const u = new URL(location.href);
              u.searchParams.set('relogin', '1');
              try{ liff.login({ scope: ['openid','profile'], prompt: 'consent', redirectUri: u.toString() }); }catch{}
            };
            $msg.innerHTML = `<span class="error">認証エラー（401）。${detail ? '詳細: '+detail : ''}</span>`;
            $msg.appendChild(document.createElement('br'));
            $msg.appendChild(btn);
          } else {
            $msg.textContent = '読み込みに失敗しました';
          }
          return;
        }
        const data = await res.json();
        pollClosed = data?.poll?.status && data.poll.status !== 'open';
        state = { options: data.options, tally: data.tally, userChoices: data.userChoices };
        document.getElementById('title').textContent = data.poll.title;
        const dl = document.getElementById('deadline');
        if (data.poll.deadline){
          const d = new Date(Number(data.poll.deadline));
          dl.textContent = `締切: ${d.toLocaleString('ja-JP')}`;
        } else dl.textContent = '';
        document.getElementById('user').textContent = `あなた: ${data.user?.name || ''}`;
        if (pollClosed){
          $msg.innerHTML = '<span class="tally">この投票は終了しました。</span>';
          $save.classList.add('disabled');
          $save.disabled = true;
        } else {
          $msg.textContent = '';
          $save.classList.remove('disabled');
          $save.disabled = false;
        }
        render();
      }

      $save.addEventListener('click', async () => {
        $msg.textContent = '';
        const inputs = Array.from(document.querySelectorAll('input[type=radio]:checked'));
        const byOption = new Map();
        for (const r of inputs){
          byOption.set(r.name, Number(r.value));
        }
        // any not selected? treat as no change (do not send)
        const choices = Array.from(byOption.entries()).map(([optionId, choice]) => ({ optionId, choice }));
        $save.classList.add('disabled');
        $save.disabled = true;
        try{
          const res = await fetch(`/api/polls/${encodeURIComponent(pollId)}/votes3`, {
            method: 'POST',
            headers: {
              'content-type': 'application/json',
              Authorization: `Bearer ${idToken}`
            },
            body: JSON.stringify({ choices })
          });
          if (!res.ok){
            const j = await res.json().catch(()=>({}));
            throw new Error(j.error || '送信に失敗しました');
          }
          const j = await res.json();
          state.tally = j.tally || state.tally;
          // サーバ状態（自分の前回投票）を反映するため再読み込み
          await load();
          $msg.textContent = '保存しました';
        }catch(e){
          $msg.innerHTML = `<span class="error">${e.message}</span>`;
        }finally{
          $save.classList.remove('disabled');
          $save.disabled = false;
        }
      });

      function subscribe(){
        const es = new EventSource(`/api/polls/${encodeURIComponent(pollId)}/stream`);
        es.onmessage = (ev) => {
          try{
            const data = JSON.parse(ev.data);
            if (data.type === 'tally'){
              state.tally = data.tally;
              render();
            }
          }catch{}
        };
      }

      init().catch(err => {
        $msg.textContent = 'LIFF 初期化に失敗: ' + err.message;
      });
    </script>
  </body>
  </html>
