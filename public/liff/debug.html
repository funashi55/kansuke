<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LIFF デバッグ: 名前のみ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans JP', sans-serif; margin: 24px; }
      .name { font-size: 24px; font-weight: 700; margin: 8px 0 16px; }
      .error { color: #b00020; white-space: pre-line; }
      .note { color: #666; font-size: 12px; margin-top: 12px; }
      .small { font-size: 12px; color: #666; }
      .hidden { display: none; }
      button { padding: 10px 14px; border-radius: 6px; border: none; background: #00c300; color: #fff; font-weight: 700; }
    </style>
  </head>
  <body>
    <div id="status" class="small">初期化中...</div>
    <div id="name" class="name"></div>
    <div id="error" class="error"></div>
    <button id="loginBtn" class="hidden">LINEでログイン</button>
    <div id="hint" class="note"></div>

    <script>
      (async () => {
        const $status = document.getElementById('status');
        const $name = document.getElementById('name');
        const $error = document.getElementById('error');
        const $hint = document.getElementById('hint');
        const $loginBtn = document.getElementById('loginBtn');

        function setStatus(msg){ $status.textContent = msg; }
        function setError(msg){ $error.textContent = msg; }
        function setName(n){ $name.textContent = n ? `あなたの名前: ${n}` : ''; }

        // 1) liffId を取得（優先度: window.__LIFF_ID__ → ?liffId=... → /api/public-config）
        const qs = new URLSearchParams(location.search);
        let liffId = (window.__LIFF_ID__ || '').trim();
        if (!liffId) {
          liffId = (qs.get('liffId') || '').trim();
        }
        if (!liffId) {
          try {
            const cfg = await fetch('/api/public-config').then(r => r.json());
            liffId = (cfg.liffId || '').trim();
          } catch (_) {}
        }
        if (!liffId) {
          setError('LIFF ID が取得できませんでした。?liffId=... を付けるか、サーバの /api/public-config を確認してください。');
          setStatus('中断');
          return;
        }

        // 2) LIFF 初期化
        try {
          setStatus('LIFF 初期化中...');
          await liff.init({ liffId });
        } catch (e) {
          setStatus('初期化失敗');
          setError(`LIFF 初期化に失敗しました\n${e && e.message ? e.message : e}`);
          $hint.innerHTML = `
            モバイルで失敗する場合、以下を確認してください。<br>
            - liffId が正しい（例: 1651234567-abCdEf）<br>
            - LIFF のエンドポイントURLのドメインとこのページのドメインが一致<br>
            - LINE アプリ内ブラウザで開いているか、外部の場合はログイン実行<br>
          `;
          return;
        }

        // 3) ログイン（外部ブラウザ時）
        if (!liff.isInClient() && !liff.isLoggedIn()) {
          setStatus('未ログイン（外部ブラウザ）');
          $loginBtn.classList.remove('hidden');
          $loginBtn.addEventListener('click', () => {
            liff.login({ redirectUri: location.href });
          });
          $hint.textContent = '外部ブラウザの場合はログインが必要です。';
          return; // ログイン後に再読み込みされる
        }

        // 4) ユーザー名の取得
        try {
          setStatus('プロフィール取得中...');
          let displayName = '';
          if (liff.isInClient()) {
            const prof = await liff.getProfile();
            displayName = prof && prof.displayName ? prof.displayName : '';
          } else {
            const idt = liff.getDecodedIDToken?.();
            displayName = (idt && (idt.name || idt.nickname)) || '';
          }
          if (!displayName) {
            setStatus('取得完了（名前なし）');
            setName('(取得できませんでした)');
          } else {
            setStatus('取得完了');
            setName(displayName);
          }
        } catch (e) {
          setStatus('プロフィール取得失敗');
          setError(`名前の取得に失敗しました\n${e && e.message ? e.message : e}`);
        }

        // 5) 追加デバッグ（?debug=1 でUAなど表示）
        if (qs.get('debug') === '1') {
          const pre = document.createElement('pre');
          pre.className = 'small';
          pre.textContent = [
            `liffId=${liffId}`,
            `isInClient=${liff.isInClient()}`,
            `isLoggedIn=${liff.isLoggedIn()}`,
            `ua=${navigator.userAgent}`,
            `href=${location.href}`,
          ].join('\n');
          document.body.appendChild(pre);
        }
      })();
    </script>
  </body>
  </html>
